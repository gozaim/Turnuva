<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Şipas Futbol Şampiyonası</title>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700&family=Roboto:wght@400;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
:root{--primary-color:#2563eb;--secondary-color:#dc2626;--accent-color:#f59e0b;--bg-primary:#0f172a;--bg-secondary:#1e293b;--text-primary:#f1f5f9;--text-secondary:#cbd5e1;--border-color:#334155;--success-color:#10b981;--danger-color:#ef4444;}
*{box-sizing:border-box}
body{font-family:'Roboto',sans-serif;background:linear-gradient(135deg,var(--bg-primary),var(--bg-secondary));color:var(--text-primary);margin:0;padding:20px;min-height:100vh;overflow-x:hidden;}
h1{display:flex;justify-content:center;align-items:center;gap:15px;margin:0 0 32px;font-family:'Orbitron',sans-serif;color:var(--primary-color);text-shadow:0 0 20px var(--primary-color);font-size:clamp(2em,5vw,3.5em);}
.logo{width:60px;height:60px;border-radius:50%;display:flex;align-items:center;justify-content:center;background:linear-gradient(45deg,var(--primary-color),var(--secondary-color));}
.section{max-width:1200px;margin:24px auto;padding:24px;background:var(--bg-secondary);border:1px solid var(--border-color);border-radius:12px;box-shadow:0 4px 18px rgba(0,0,0,.35);}
/* YENİ: Başlık ve butonu yan yana getirmek için */
.section-header { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 16px; margin-bottom: 16px; }
.section-header h2 { margin: 0; }
h2{font-family:'Orbitron',sans-serif;color:var(--secondary-color);display:flex;align-items:center;gap:10px;margin:0 0 16px;}
.form-group{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin:12px 0 8px;}
input,select{padding:12px 16px;border:2px solid var(--border-color);border-radius:8px;background:var(--bg-primary);color:var(--text-primary);min-width:180px;}
button{padding:12px 18px;border:none;border-radius:8px;background:var(--primary-color);color:#fff;font-weight:700;cursor:pointer;display:inline-flex;align-items:center;gap:8px;}
button:hover{background:#1d4ed8;transform:translateY(-1px);} button:disabled{background:#6b7280;cursor:not-allowed;transform:none;}
.btn-secondary{background:var(--text-secondary);color:#111827;} .btn-danger{background:var(--danger-color);} .btn-success{background:var(--success-color);}
.tournament-types{display:flex;gap:12px;flex-wrap:wrap;margin:10px 0;}
.tournament-type{padding:10px 14px;border:1px solid var(--border-color);border-radius:8px;background:var(--bg-primary);cursor:pointer;user-select:none;display:inline-flex;align-items:center;gap:8px;}
.tournament-type.active{outline:2px solid var(--primary-color);box-shadow:0 0 0 3px rgba(37,99,235,.25);} .tournament-type:active{transform:scale(.98);}
.auto-advance{display:flex;align-items:center;gap:10px;margin-top:8px;}
.switch{position:relative;display:inline-block;width:42px;height:24px;margin-right:6px;}
.switch input{opacity:0;width:0;height:0;}
.slider{position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background:#64748b;transition:.2s;border-radius:34px;}
.slider:before{position:absolute;content:'';height:18px;width:18px;left:3px;bottom:3px;background:#fff;transition:.2s;border-radius:50%;}
input:checked + .slider{background:#22c55e;} input:checked + .slider:before{transform:translateX(18px);}
.player-card{background:var(--bg-primary);border:1px solid var(--border-color);border-radius:10px;padding:14px;margin:10px 0;display:flex;justify-content:space-between;align-items:center;}
.player-info{display:flex;align-items:center;gap:14px;}
.player-avatar{position:relative;width:40px;height:40px;border-radius:50%;background:var(--primary-color);display:flex;align-items:center;justify-content:center;font-weight:800;color:#fff;overflow:hidden;}
.player-avatar.has-img{background:transparent;color:transparent;}
.player-avatar img{position:absolute;inset:0;width:100%;height:100%;object-fit:contain;display:block;padding:2px;}
.team-badge{padding:4px 8px;background:var(--accent-color);color:#111827;border-radius:10px;font-size:12px;font-weight:700;cursor:pointer;}
.badge{display:inline-block;padding:2px 6px;border-radius:6px;font-size:11px;font-weight:700;background:var(--bg-primary);border:1px solid var(--border-color);margin:0 6px;}
.badge-home{color:var(--success-color);} .badge-away{color:var(--danger-color);}
.table-responsive { overflow-x: auto; -webkit-overflow-scrolling: touch; }
table{width:100%;border-collapse:separate;border-spacing:0;margin-top:16px;border-radius:10px;overflow:hidden;background:var(--bg-primary);border:1px solid var(--border-color);}
th,td{padding:12px 8px;text-align:center;border-bottom:1px solid var(--border-color);white-space:nowrap;}
th{background:var(--primary-color);color:#fff;text-transform:uppercase;font-size:12px;}
tbody tr{background:var(--bg-secondary);} tbody tr:hover{background:#334155!important;}
.position-badge{display:inline-grid;place-items:center;width:30px;height:30px;border-radius:50%;font-weight:800;}
.position-1{background:linear-gradient(45deg,#ffd700,#ffef63);} .position-2{background:linear-gradient(45deg,#c0c0c0,#ececec);} .position-3{background:linear-gradient(45deg,#cd7f32,#daa520);} .position-other{background:linear-gradient(45deg,var(--primary-color),#4da6ff);color:#fff;}
.week-navigation{display:flex;justify-content:center;align-items:center;gap:12px;margin:10px 0 0;}
.match-container{display:grid;gap:16px;margin-top:16px;}
.match{display:grid;grid-template-columns:1fr auto 1fr;align-items:center;background:var(--bg-secondary);border:1px solid var(--border-color);border-radius:10px;padding:16px;}
.team-home,.team-away{display:flex;align-items:center;gap:12px;font-weight:700;font-size:18px;}
.team-away{justify-content:flex-end;text-align:right;}
.match-center{display:flex;flex-direction:column;align-items:center;gap:10px;min-width:200px;}
.score-inputs{display:flex;align-items:center;gap:8px;}
.score-input{width:70px;text-align:center;font-weight:800;font-size:20px;}
.score-separator{font-size:22px;font-weight:800;color:var(--primary-color);}
.match.locked{background:var(--bg-primary);border-color:var(--success-color);}
.score-display{font-size:20px;font-weight:800;}
.muted{color:var(--text-secondary);font-style:italic;}
.modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.8);z-index:1000;backdrop-filter:blur(5px);}
.modal-content{background:var(--bg-secondary);width:90%;max-width:860px;margin:5% auto;border-radius:12px;border:1px solid var(--border-color);overflow:hidden;max-height:80vh;display:flex;flex-direction:column;}
.modal-header{background:var(--primary-color);color:#fff;padding:16px 20px;display:flex;align-items:center;justify-content:space-between;}
.modal-body{padding:16px 22px;overflow:auto;}
.simple-list{display:flex;flex-direction:column;gap:8px;}
.simple-row{padding:10px 12px;border:1px solid var(--border-color);border-radius:8px;background:var(--bg-primary);text-align:center;font-size:16px;}
.notification{position:fixed;top:20px;right:20px;padding:12px 16px;border-radius:10px;color:#fff;font-weight:800;transform:translateX(380px);transition:.25s;z-index:1200;}
.notification.show{transform:translateX(0);} .notification.success{background:linear-gradient(45deg,var(--success-color),#00ff88);} .notification.error{background:linear-gradient(45deg,var(--danger-color),#ff6b9d);}
.champion-overlay{position:fixed;inset:0;z-index:1500;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.55);backdrop-filter:blur(3px);}
.champion-box{position:relative;text-align:center;padding:24px 28px;border-radius:16px;border:1px solid var(--border-color);background:linear-gradient(135deg,#0b1224 0%, #12203a 100%);box-shadow:0 10px 40px rgba(0,0,0,.5);}
.champion-title{font-family:'Orbitron',sans-serif;font-size:clamp(32px,6vw,64px);font-weight:800;letter-spacing:.04em;text-transform:uppercase;color:#fff;animation:pulse 1s ease-in-out infinite, floatY 2.5s ease-in-out infinite;}
.champion-sub{margin-top:8px;color:#fef3c7;font-weight:700;}
@keyframes pulse{0%,100%{text-shadow:0 0 16px #ffd700,0 0 32px #ffed4a}50%{text-shadow:0 0 8px #ffd700}}
@keyframes floatY{0%,100%{transform:translateY(0)}50%{transform:translateY(-6px)}}
.confetti-canvas{position:absolute;inset:0;pointer-events:none;border-radius:16px}
#champion-actions{display:none;margin-bottom:12px;display:flex;gap:10px;flex-wrap:wrap;align-items:center;}
.banner-shot{display:flex;justify-content:center;align-items:center;padding:12px 16px;margin-bottom:12px;border-radius:10px;border:1px dashed rgba(255,255,255,.2);background:linear-gradient(90deg,rgba(245,158,11,.15),rgba(37,99,235,.15));font-weight:800;}

@media (max-width: 768px) {
  body { padding: 10px; }
  .section { padding: 16px; }
  h1 { font-size: clamp(1.8em, 7vw, 2.5em); }
  th, td { padding: 10px 6px; font-size: 13px; }
  .match { grid-template-columns: 1fr; gap: 12px; padding: 12px; }
  .team-away { justify-content: flex-start; text-align: left; }
  .match-center { min-width: 0; }
}
</style>
</head>
<body>
  <h1><div class="logo">⚽</div>Şipas Futbol Şampiyonası</h1>

  <div id="champion-overlay" class="champion-overlay" aria-hidden="true">
    <div class="champion-box">
      <canvas id="confetti" class="confetti-canvas"></canvas>
      <div id="champion-title" class="champion-title">ŞAMPİYON</div>
      <div id="champion-sub" class="champion-sub">Tebrikler!</div>
    </div>
  </div>

  <div class="section" id="players-section">
    <h2><i class="fas fa-users"></i> Oyuncular ve Takımlar</h2>
    <div class="tournament-types">
      <div class="tournament-type active" data-type="league"><i class="fas fa-trophy"></i> Rovanşlı </div>
      <div class="tournament-type" data-type="single"><i class="fas fa-clock"></i> Tek Maç</div>
    </div>
    <div class="form-group">
      <input id="player-name" placeholder="Oyuncu Adı">
      <input id="team-name" placeholder="Takım Adı">
      <button id="add-player-btn"><i class="fas fa-user-plus"></i> Oyuncu Ekle</button>
    </div>
    <div class="auto-advance">
      <label class="switch"><input type="checkbox" id="auto-advance" checked><span class="slider"></span></label>
      <span>Otomatik hafta geçişi</span>
    </div>
    <div id="players-list"></div>
    <div style="text-align:center;margin-top:18px;display:flex;gap:10px;justify-content:center;flex-wrap:wrap;">
      <button id="generate-btn" disabled><i class="fas fa-calendar-alt"></i> Turnuvayı Başlat</button>
      <button class="reset-tournament-btn btn-danger"><i class="fas fa-sync-alt"></i> Turnuvayı Sıfırla</button>
    </div>
  </div>

  <div class="section" id="standings-section" style="display:none;">
    <!-- YENİ: Başlık ve sıfırlama butonu için sarmalayıcı -->
    <div class="section-header">
      <h2><i class="fas fa-chart-line"></i> Puan Tablosu</h2>
      <button class="reset-tournament-btn btn-danger"><i class="fas fa-sync-alt"></i> Turnuvayı Sıfırla</button>
    </div>

    <div id="champion-actions">
      <button id="btn-shot" class="btn-success"><i class="fa-solid fa-camera"></i> Ekran Görüntüsü Al</button>
      <span id="champion-actions-info" class="badge">Şampiyonluk kaydı hazır</span>
    </div>
    
    <div class="table-responsive">
      <table id="standings">
        <thead><tr><th>Sıra</th><th>Oyuncu</th><th>Takım</th><th>O</th><th>G</th><th>B</th><th>M</th><th>A</th><th>Y</th><th>Av</th><th>P</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <div class="section" id="fixture-section" style="display:none;">
    <h2><i class="fas fa-calendar-alt"></i> Maç Programı</h2>
    <div class="week-navigation">
      <button class="btn-secondary" id="prev-week-btn"><i class="fas fa-chevron-left"></i> Önceki</button>
      <span id="display-week-info" class="badge">1. Hafta</span>
      <button class="btn-secondary" id="next-week-btn">Sonraki <i class="fas fa-chevron-right"></i></button>
    </div>
    <div id="current-week"></div>
  </div>

  <div class="modal" id="player-modal">
    <div class="modal-content">
      <div class="modal-header">
        <div id="player-modal-title" style="font-size:20px;font-weight:800;"></div>
        <span class="close" data-close="player-modal" style="cursor:pointer;font-size:24px;">&times;</span>
      </div>
      <div class="modal-body">
        <div id="player-chart" class="simple-row" style="padding:0;"></div>
        <div id="player-matches" class="simple-list"></div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script>
// --- STATE ---
let players = [];
let weeks = [];
let standings = {};
let currentWeek = 0;
let displayWeek = 0;
let tournamentType = 'league';
let totalMatches = 0;
let championAnnounced = false;
let championTeamCached = null;
let finalScheduled = false;

// --- VERİ KALICILIĞI ---
function saveState() {
    const state = {
        players, weeks, standings, currentWeek, displayWeek, tournamentType,
        totalMatches, championAnnounced, championTeamCached, finalScheduled
    };
    localStorage.setItem('sipasTournamentState', JSON.stringify(state));
}

function loadState() {
    const savedState = localStorage.getItem('sipasTournamentState');
    if (savedState) {
        const state = JSON.parse(savedState);
        players = state.players || [];
        weeks = state.weeks || [];
        standings = state.standings || {};
        currentWeek = state.currentWeek || 0;
        displayWeek = state.displayWeek || 0;
        tournamentType = state.tournamentType || 'league';
        totalMatches = state.totalMatches || 0;
        championAnnounced = state.championAnnounced || false;
        championTeamCached = state.championTeamCached || null;
        finalScheduled = state.finalScheduled || false;
        
        if (weeks.length > 0) {
            byId('players-section').style.display = 'none';
            byId('standings-section').style.display = 'block';
            byId('fixture-section').style.display = 'block';
            renderStandings();
            renderCurrentWeek();
        } else {
            updatePlayersList();
        }
        checkGenerateButton();
    }
}

function resetTournament() {
    if (confirm('Emin misiniz? Kayıtlı tüm turnuva verileri silinecek ve baştan başlayacaksınız.')) {
        localStorage.removeItem('sipasTournamentState');
        location.reload();
    }
}

// --- HELPERS ---
const byId = (id) => document.getElementById(id);
function createAvatarHTML(name, size=40){
  const safe = (name || 'U').trim(); const initial = safe.charAt(0).toUpperCase(); const src = encodeURI(safe) + '.png';
  return `<div class="player-avatar" style="width:${size}px;height:${size}px;font-size:${Math.max(14, Math.floor(size*0.4))}px;">${initial}<img src="${src}" alt="${safe}" onerror="this.remove()" onload="this.parentElement.classList.add('has-img')"></div>`;
}
function showNotification(msg, type='success'){
  const n = document.createElement('div'); n.className = 'notification ' + type; n.textContent = msg; document.body.appendChild(n);
  requestAnimationFrame(()=>n.classList.add('show')); setTimeout(()=>{ n.classList.remove('show'); setTimeout(()=>n.remove(), 250); }, 2500);
}
function updateWeekNav(){
  byId('prev-week-btn').disabled = displayWeek <= 0;
  byId('next-week-btn').disabled = displayWeek >= weeks.length - 1;
  byId('display-week-info').textContent = weeks.length > 0 && weeks[displayWeek][0]?.isFinal ? 'FİNAL' : (displayWeek+1)+'. Hafta';
}
function changeDisplayWeek(dir){ const nw = displayWeek + dir; if(nw>=0 && nw<weeks.length){ displayWeek = nw; renderCurrentWeek(); } }
function handleNextWeekClick(){
  if(displayWeek === currentWeek){
    const complete = weeks[currentWeek] && weeks[currentWeek].every(m=>m.locked);
    if(complete && currentWeek < weeks.length - 1){
      currentWeek++; displayWeek = currentWeek; renderCurrentWeek(); showNotification((currentWeek+1)+'. hafta başladı!', 'success'); saveState(); return;
    }
  }
  changeDisplayWeek(1);
}
function handlePrevWeekClick(){ changeDisplayWeek(-1); }

// --- PLAYERS ---
function addPlayer(){
  const pn = byId('player-name').value.trim(); const tn = byId('team-name').value.trim();
  if(!pn || !tn){ showNotification('Oyuncu ve takım adı zorunludur!', 'error'); return; }
  if(players.some(p=>p.player.toLowerCase()===pn.toLowerCase())){ showNotification('Bu oyuncu zaten eklenmiş!', 'error'); return; }
  players.push({player:pn, team:tn});
  standings[pn] = { team: tn, played:0, wins:0, draws:0, losses:0, gf:0, ga:0, gd:0, points:0, matches:[] };
  byId('player-name').value=''; byId('team-name').value='';
  updatePlayersList(); checkGenerateButton(); showNotification(pn+' eklendi!');
  saveState();
}
function updatePlayersList(){
  const list = byId('players-list'); list.innerHTML='';
  players.forEach((p,i)=>{
    const card = document.createElement('div'); card.className='player-card';
    card.innerHTML = `
      <div class="player-info">
        ${createAvatarHTML(p.player,40)}
        <div>
          <div style="font-weight:800;cursor:pointer" data-player="${p.player}">${p.player}</div>
          <div class="team-badge team-click" data-team="${p.team}" title="Detayları gör">${p.team}</div>
        </div>
      </div>
      <button class="btn-danger" data-remove="${i}"><i class="fas fa-trash"></i></button>`;
    list.appendChild(card);
  });
  list.querySelectorAll('[data-remove]').forEach(btn=>btn.addEventListener('click',(e)=>{
    const idx = +e.currentTarget.dataset.remove; const pl = players[idx]; delete standings[pl.player]; players.splice(idx,1);
    updatePlayersList(); checkGenerateButton(); showNotification(pl.player+' silindi','success'); saveState();
  }));
  list.querySelectorAll('[data-player]').forEach(td=>td.addEventListener('click',()=>showPlayerModal(td.dataset.player)));
  list.querySelectorAll('.team-click').forEach(td=>td.addEventListener('click',()=>{
    const t = td.dataset.team; const entry = Object.entries(standings).find(([pl,st]) => st.team === t); if(entry) showPlayerModal(entry[0]);
  }));
}
function checkGenerateButton(){ byId('generate-btn').disabled = players.length < 2; }

// --- FIXTURE ---
function generateSingleRoundRobin(list){
  let arr = [...list];
  if(arr.length%2===1) arr = [...arr, {player:'BAY', team:'BAY'}];
  const tot = arr.length - 1; const rounds = [];
  for(let r=0;r<tot;r++){
    const week = [];
    const half = arr.length/2;
    for(let i=0;i<half;i++){
      const home = arr[i], away = arr[arr.length-1-i];
      if(home.player!=='BAY' && away.player!=='BAY'){
        week.push({home,away,homeScore:null,awayScore:null,locked:false});
      }
    }
    rounds.push(week);
    const last = arr.pop(); arr.splice(1,0,last);
  }
  return rounds;
}
function generateFixture(){
  if(players.length<2){ showNotification('En az 2 oyuncu gerekli!','error'); return; }
  const firstLeg = generateSingleRoundRobin(players);
  if(tournamentType==='league'){
    const secondLeg = firstLeg.map(week=>week.map(m=>({home:m.away,away:m.home,homeScore:null,awayScore:null,locked:false})));
    weeks = [...firstLeg, ...secondLeg];
  }else{
    weeks = firstLeg; }
  totalMatches = weeks.reduce((t,w)=>t+w.length,0);
  currentWeek = 0; displayWeek = 0;
  championAnnounced = false; championTeamCached = null; finalScheduled = false;
  byId('players-section').style.display='none';
  byId('standings-section').style.display='block';
  byId('fixture-section').style.display='block';
  byId('champion-actions').style.display='none';
  renderStandings(); renderCurrentWeek();
  saveState();
}
function renderCurrentWeek(){
  const cont = byId('current-week'); cont.innerHTML='';
  if(weeks.length===0) return;
  updateWeekNav();
  const idx = displayWeek;
  const box = document.createElement('div'); box.className='match-container';
  weeks[idx].forEach((m,mi)=>{
    const canEdit = (idx===currentWeek);
    const center = document.createElement('div'); center.className='match-center';
    if(m.locked){
      center.innerHTML = `<div class="score-display">${m.homeScore} - ${m.awayScore}</div>` + (canEdit?`<div class="match-actions"><button class="btn-secondary" data-edit="${idx}-${mi}"><i class="fas fa-edit"></i> Düzenle</button></div>`:'')
    }else if(canEdit){
      center.innerHTML = `<div class="score-inputs">
          <input id="hs-${idx}-${mi}" type="number" min="0" class="score-input" placeholder="0" value="${m.homeScore??''}">
          <span class="score-separator">-</span>
          <input id="as-${idx}-${mi}" type="number" min="0" class="score-input" placeholder="0" value="${m.awayScore??''}">
        </div>
        <div class="match-actions">
          <button data-lock="${idx}-${mi}"><i class="fas fa-save"></i> Kaydet</button>
          <button class="btn-secondary" data-random="${idx}-${mi}"><i class="fas fa-dice"></i> Rastgele</button>
        </div>`;
    }else{
      center.innerHTML = `<div class="score-display muted">Henüz Oynanmadı</div>`;
    }
    const row = document.createElement('div'); row.className='match'+(m.locked?' locked':'');
    row.innerHTML = `
      <div class="team-home">
        ${createAvatarHTML(m.home.player,40)}
        <div>
          <div style="font-weight:800;cursor:pointer" data-player="${m.home.player}">${m.home.player}</div>
          <div class="team-badge team-click" data-team="${m.home.team}" title="Detayları gör">${m.home.team}</div>
        </div>
      </div>
      ${center.outerHTML}
      <div class="team-away">
        <div>
          <div style="font-weight:800;cursor:pointer" data-player="${m.away.player}">${m.away.player}</div>
          <div class="team-badge team-click" data-team="${m.away.team}" title="Detayları gör">${m.away.team}</div>
        </div>
        ${createAvatarHTML(m.away.player,40)}
      </div>`;
    const parser = new DOMParser(); const doc = parser.parseFromString(row.innerHTML, 'text/html');
    row.innerHTML = doc.body.innerHTML;
    row.querySelectorAll('[data-edit]').forEach(b=>b.addEventListener('click',()=>{ const [w,i]=b.dataset.edit.split('-').map(Number); editScore(w,i); }));
    row.querySelectorAll('[data-lock]').forEach(b=>b.addEventListener('click',()=>{ const [w,i]=b.dataset.lock.split('-').map(Number); lockScore(w,i); }));
    row.querySelectorAll('[data-random]').forEach(b=>b.addEventListener('click',()=>{ const [w,i]=b.dataset.random.split('-').map(Number); quickScore(w,i); }));
    row.querySelectorAll('[data-player]').forEach(td=>td.addEventListener('click',()=>showPlayerModal(td.dataset.player)));
    row.querySelectorAll('.team-click').forEach(td=>td.addEventListener('click',()=>{
      const t = td.dataset.team; const entry = Object.entries(standings).find(([pl,st])=>st.team===t); if(entry) showPlayerModal(entry[0]);
    }));
    box.appendChild(row);
  });
  cont.appendChild(box);
}
function lockScore(wi, mi){
  const m = weeks[wi][mi];
  const hs = parseInt(byId(`hs-${wi}-${mi}`).value);
  const as = parseInt(byId(`as-${wi}-${mi}`).value);
  if(Number.isNaN(hs)||Number.isNaN(as)){ showNotification('Skorları girin!','error'); return; }
  if(m.isFinal && hs === as) { showNotification('Final maçı berabere bitemez!', 'error'); return; }
  const oldHs = m.homeScore, oldAs = m.awayScore, wasLocked = m.locked;
  m.homeScore = hs; m.awayScore = as; m.locked = true;
  if(!wasLocked) applyToStandings(m, oldHs, oldAs, false, wi, false); else applyToStandings(m, oldHs, oldAs, true, wi, true);
  renderStandings(); renderCurrentWeek(); showNotification('Maç kaydedildi!');
  if(weeks[currentWeek].every(x=>x.locked) && currentWeek < weeks.length-1){
    if(byId('auto-advance').checked){ currentWeek++; displayWeek=currentWeek; renderCurrentWeek(); }
    else { showNotification('Hafta tamamlandı. Sonraki haftaya geçmek için "Sonraki" butonuna basın.', 'success'); }
  }
  checkChampionClinched();
  saveState();
}
function editScore(wi, mi){
  const m = weeks[wi][mi];
  if(m.locked){
    const oldHs = m.homeScore;
    const oldAs = m.awayScore;
    applyToStandings(m, oldHs, oldAs, true, wi, true);
  }
  m.locked = false;
  renderStandings();
  renderCurrentWeek();
  showNotification('Düzenleme açık');
  saveState();
}
function quickScore(wi, mi){
  const hs = Math.floor(Math.random()*4 + (Math.random()<.1?2:0));
  const as = Math.floor(Math.random()*4 + (Math.random()<.1?2:0));
  byId(`hs-${wi}-${mi}`).value = hs; byId(`as-${wi}-${mi}`).value = as;
}
function removeMatchRecord(player, weekIndex, opponent){
  const arr = standings[player].matches;
  const targetWeek = (weekIndex??0) + 1;
  const idx = arr.findIndex(r => r.week === targetWeek && r.opponent === opponent);
  if(idx !== -1){ arr.splice(idx,1); }
  else { arr.pop?.(); }
}

function applyToStandings(m, oldHs, oldAs, revert, wi, skipAdd=false){
  const H = m.home.player, A = m.away.player, hs = m.homeScore, as = m.awayScore;
  if(!revert){ standings[H].played++; standings[A].played++; }
  else{
    standings[H].played--; standings[A].played--;
    standings[H].gf -= oldHs; standings[H].ga -= oldAs;
    standings[A].gf -= oldAs; standings[A].ga -= oldHs;
    if(oldHs>oldAs){ standings[H].wins--; standings[H].points-=3; standings[A].losses--; }
    else if(oldHs<oldAs){ standings[A].wins--; standings[A].points-=3; standings[H].losses--; }
    else{ standings[H].draws--; standings[A].draws--; standings[H].points--; standings[A].points--; }
    removeMatchRecord(H, wi, A);
    removeMatchRecord(A, wi, H);
  }
  if(!skipAdd) {
    standings[H].gf += hs; standings[H].ga += as;
    standings[A].gf += as; standings[A].ga += hs;
    standings[H].gd = standings[H].gf - standings[H].ga;
    standings[A].gd = standings[A].gf - standings[A].ga;
    if(hs>as){ standings[H].wins++; standings[H].points+=3; standings[A].losses++; pushMatch(H, A, hs, as, 'Galibiyet', true, wi); pushMatch(A, H, as, hs, 'Mağlubiyet', false, wi); }
    else if(hs<as){ standings[A].wins++; standings[A].points+=3; standings[H].losses++; pushMatch(H, A, hs, as, 'Mağlubiyet', true, wi); pushMatch(A, H, as, hs, 'Galibiyet', false, wi); }
    else{ standings[H].draws++; standings[A].draws++; standings[H].points++; standings[A].points++; pushMatch(H, A, hs, as, 'Beraberlik', true, wi); pushMatch(A, H, as, hs, 'Beraberlik', false, wi); }
  }
}
function pushMatch(p, opp, hs, as, res, isHome, weekIndex){
  standings[p].matches.push({opponent:opp, homeScore:hs, awayScore:as, result:res, isHome, week: (weekIndex??currentWeek)+1, oppTeam: standings[opp].team, selfTeam: standings[p].team});
}
function renderStandings(){
  const tb = byId('standings').querySelector('tbody'); tb.innerHTML='';
  const rows = Object.entries(standings).sort((a,b)=> b[1].points-a[1].points || b[1].gd-a[1].gd || b[1].gf-a[1].gf);
  rows.forEach(([pl,st],i)=>{
    const tr = document.createElement('tr');
    const posClass = i===0?'position-1':i===1?'position-2':i===2?'position-3':'position-other';
    tr.innerHTML = `
      <td><span class="position-badge ${posClass}">${i+1}</span></td>
      <td style="cursor:pointer;font-weight:800" data-player="${pl}">${pl}</td>
      <td class="team-click" data-team="${st.team}" style="cursor:pointer;">${st.team}</td>
      <td>${st.played}</td><td style="color:var(--success-color)">${st.wins}</td><td style="color:var(--accent-color)">${st.draws}</td>
      <td style="color:var(--danger-color)">${st.losses}</td><td style="color:var(--primary-color)">${st.gf}</td>
      <td style="color:var(--secondary-color)">${st.ga}</td><td>${st.gd>=0?('+'+st.gd):st.gd}</td><td style="font-weight:800;color:var(--accent-color)">${st.points}</td>`;
    tb.appendChild(tr);
  });
  tb.querySelectorAll('[data-player]').forEach(td=>td.addEventListener('click',()=>showPlayerModal(td.dataset.player)));
  tb.querySelectorAll('.team-click').forEach(td=>td.addEventListener('click',()=>{
    const t = td.dataset.team; const entry = Object.entries(standings).find(([pl,st]) => st.team === t); if(entry) showPlayerModal(entry[0]);
  }));
  checkChampionClinched();
}

// --- RANK CHART ---
function computeRanksPerWeek(player){
  const nWeeks = weeks.length; const result = []; const playersList = players.map(p => p.player);
  for(let w=0; w<nWeeks; w++){
    const acc = {}; playersList.forEach(pl => acc[pl] = {points:0, gd:0, gf:0, ga:0, wins:0, draws:0, losses:0, played:0});
    for(let i=0; i<=w; i++){
      weeks[i].forEach(m => {
        if(!m.locked) return;
        const H = m.home.player, A = m.away.player, hs = m.homeScore, as = m.awayScore;
        acc[H].played++; acc[A].played++;
        acc[H].gf += hs; acc[H].ga += as; acc[A].gf += as; acc[A].ga += hs;
        acc[H].gd = acc[H].gf - acc[H].ga; acc[A].gd = acc[A].gf - acc[A].ga;
        if(hs>as){ acc[H].wins++; acc[A].losses++; acc[H].points += 3; }
        else if(hs<as){ acc[A].wins++; acc[H].losses++; acc[A].points += 3; }
        else { acc[H].draws++; acc[A].draws++; acc[H].points++; acc[A].points++; }
      });
    }
    const anyPlayed = Object.values(acc).some(v => v.played>0);
    if(!anyPlayed){ result.push({week:w+1, rank:null}); continue; }
    const sorted = Object.entries(acc).sort((a,b)=> b[1].points - a[1].points || b[1].gd - a[1].gd || b[1].gf - a[1].gf);
    const rank = sorted.findIndex(([pl]) => pl === player) + 1;
    result.push({week:w+1, rank: rank || null});
  }
  return result;
}
function renderRankChart(player, containerId){
  const series = computeRanksPerWeek(player); const container = byId(containerId);
  const width = 820, height = 260, padL=50, padR=20, padT=20, padB=30;
  const N = Math.max(players.length, 1); const W = Math.max(weeks.length, 1);
  const xMin = 1, xMax = W; const yMin = 1, yMax = N;
  function xScale(week){ return padL + ((week - xMin) / ((xMax - xMin) || 1)) * (width - padL - padR); }
  function yScale(rank){ const t = padT, b = height - padB; return t + ((rank - yMin) / ((yMax - yMin) || 1)) * (b - t); }
  const pts = series.map(d => (d.rank ? `${xScale(d.week)},${yScale(d.rank)}` : null)).filter(Boolean);
  const circles = series.map(d => d.rank ? `<circle cx="${xScale(d.week)}" cy="${yScale(d.rank)}" r="3"></circle>` : '').join('');
  const xTicks = Array.from({length: xMax}, (_, i) => i + 1).map(w => `<g transform="translate(${xScale(w)},${height - padB})"><line y2="6"></line><text y="20" text-anchor="middle" font-size="10">${w}</text></g>`).join('');
  const yTicks = Array.from({length: yMax}, (_, i) => i + 1).map(r => `<g transform="translate(${padL},${yScale(r)})"><line x1="-6" x2="0"></line><text x="-10" y="4" text-anchor="end" font-size="10">${r}</text></g>`).join('');
  const polyline = pts.length > 1 ? `<polyline fill="none" stroke="currentColor" stroke-width="2" points="${pts.join(' ')}"></polyline>` : '';
  container.innerHTML = `<svg viewBox="0 0 ${width} ${height}" width="100%" height="${height}" style="display:block">
    <g stroke="rgba(255,255,255,.2)"><line x1="${padL}" y1="${height-padB}" x2="${width-padR}" y2="${height-padB}"></line><line x1="${padL}" y1="${padT}" x2="${padL}" y2="${height-padB}"></line></g>
    <g stroke="rgba(255,255,255,.2)">${xTicks}${yTicks}</g>
    <g fill="none" stroke="#f59e0b">${polyline}</g>
    <g fill="#f59e0b">${circles}</g>
    <text x="${(padL+width-padR)/2}" y="${height-6}" text-anchor="middle" font-size="12" fill="#cbd5e1">Hafta</text>
    <text transform="translate(14 ${(padT+height-padB)/2}) rotate(-90)" text-anchor="middle" font-size="12" fill="#cbd5e1">Sıra (1 = en iyi)</text>
  </svg>`;
}

// --- MODAL ---
function showPlayerModal(player){
  const modal = byId('player-modal'); const title = byId('player-modal-title'); const list = byId('player-matches'); const ps = standings[player];
  title.innerHTML = `<div style="display:flex;align-items:center;gap:12px;">${createAvatarHTML(player,50)}<div><div style="font-size:22px;font-weight:800">${player}</div><div class="team-badge">${ps.team}</div></div></div>`;
  renderRankChart(player, 'player-chart'); list.innerHTML='';
  for(let w=0; w<weeks.length; w++){
    const scheduled = weeks[w].filter(m => m.home.player===player || m.away.player===player);
    scheduled.forEach(m => {
      const homeName = m.home.team; const awayName = m.away.team; const score = m.locked ? `${m.homeScore} - ${m.awayScore}` : '-';
      const row = document.createElement('div'); row.className='simple-row';
      row.innerHTML = `<div style="display:flex;justify-content:center;gap:8px;align-items:center;flex-wrap:wrap;">
          <span class="muted">Wk ${w+1}</span>
          <span><span class="badge badge-home">Home</span> ${homeName}</span>
          <span>  -  ${score}  -  </span>
          <span>${awayName} <span class="badge badge-away">Away</span></span>
        </div>`;
      list.appendChild(row);
    });
  }
  if(list.children.length===0){ list.innerHTML = '<div class="simple-row muted">Henüz planlanmış maç yok.</div>'; }
  modal.style.display='block';
}
function closeModal(id){ byId(id).style.display='none'; }

/* ======== ŞAMPİYONLUK KONTROL & KONFETİ ======== */
function remainingMatchesFor(playerName){
  let rem = 0;
  for(let w = 0; w < weeks.length; w++){
    for(const m of weeks[w]){
      const involves = (m.home.player === playerName || m.away.player === playerName);
      if(involves && !m.locked) rem++;
    }
  }
  return rem;
}
function isSeasonComplete(){
  return weeks.length>0 && weeks.every(w => w.every(m => m.locked));
}
function scheduleFinal(p1, p2){
  if(finalScheduled) return;
  finalScheduled = true;
  weeks.push([{
    home: { player: p1, team: standings[p1].team },
    away: { player: p2, team: standings[p2].team },
    homeScore: null, awayScore: null, locked: false, isFinal: true
  }]);
  currentWeek = weeks.length - 1;
  displayWeek = currentWeek;
  renderCurrentWeek();
  showNotification('Şampiyonluk Finali planlandı! Beraberlik kabul edilmez.', 'success');
  saveState();
}
function checkChampionClinched(){
  if(championAnnounced || players.length < 2 || weeks.length === 0) return;
  const rows = Object.entries(standings).sort((a,b)=> b[1].points-a[1].points || b[1].gd-a[1].gd || b[1].gf-a[1].gf);
  if(rows.length === 0) return;
  const [leaderName, leaderStat] = rows[0];
  const leaderPts = leaderStat.points;
  let anyoneCanCatch = false;
  for(let i=1; i<rows.length; i++){
    const [name, st] = rows[i];
    const rem = remainingMatchesFor(name);
    const maxPossible = st.points + rem*3;
    if(maxPossible >= leaderPts){ anyoneCanCatch = true; break; }
  }
  if(isSeasonComplete()){
    const rows2 = Object.entries(standings).sort((a,b)=> b[1].points-a[1].points || b[1].gd-a[1].gd || b[1].gf-a[1].gf);
    if(rows2.length >= 2){
      const [n1,s1] = rows2[0]; const [n2,s2] = rows2[1];
      const allEqual = (s1.points===s2.points) && (s1.gd===s2.gd) && (s1.gf===s2.gf);
      if(allEqual && !finalScheduled){ scheduleFinal(n1, n2); return; }
    }
    const championPlayer = rows2[0][0];
    const team = standings[championPlayer].team || 'Takım';
    showChampionOverlay(team); championTeamCached = team; championAnnounced = true; revealChampionActions(); saveState(); return;
  }
  if(!anyoneCanCatch){
    const team = leaderStat.team || 'Takım';
    showChampionOverlay(team);
    championTeamCached = team;
    championAnnounced = true;
    revealChampionActions();
    saveState();
  }
}
function showChampionOverlay(teamName){
  const overlay = byId('champion-overlay'); const title = byId('champion-title'); const sub = byId('champion-sub');
  title.textContent = `ŞAMPİYON ${teamName}`; sub.textContent = 'Tebrikler! Şampiyonluk garantilendi.';
  overlay.style.display = 'flex'; startConfetti(); setTimeout(()=>{ stopConfetti(); overlay.style.display='none'; }, 6000);
}
let confettiCtx, confettiAnim, confettiPieces = [];
function startConfetti(){
  const canvas = byId('confetti'); const box = canvas.parentElement.getBoundingClientRect();
  canvas.width = box.width; canvas.height = box.height; confettiCtx = canvas.getContext('2d');
  confettiPieces = Array.from({length: 140}).map(()=>spawnPiece(canvas.width, canvas.height));
  let last = performance.now();
  function frame(ts){ const dt = Math.min(0.033, (ts - last)/1000); last = ts; drawConfetti(dt, canvas.width, canvas.height); confettiAnim = requestAnimationFrame(frame); }
  confettiAnim = requestAnimationFrame(frame); window.addEventListener('resize', onResizeConfetti);
}
function stopConfetti(){ cancelAnimationFrame(confettiAnim); window.removeEventListener('resize', onResizeConfetti); }
function onResizeConfetti(){ const canvas = byId('confetti'); const box = canvas.parentElement.getBoundingClientRect(); canvas.width = box.width; canvas.height = box.height; }
function spawnPiece(w,h){
  return { x: Math.random()*w, y: -20 - Math.random()*h*0.3, vx: -100 + Math.random()*200, vy: 50 + Math.random()*200, size: 4 + Math.random()*6, rot: Math.random()*Math.PI*2, vr: -6 + Math.random()*12, life: 2 + Math.random()*2, color: `hsl(${Math.floor(Math.random()*360)},90%,60%)` };
}
function drawConfetti(dt,w,h){
  const c = confettiCtx; c.clearRect(0,0,w,h);
  for(const p of confettiPieces){
    p.vy += 180*dt; p.x += p.vx*dt; p.y += p.vy*dt; p.rot += p.vr*dt; p.life -= dt*0.25;
    if(p.y > h+30 || p.x<-30 || p.x> w+30 || p.life<=0){ Object.assign(p, spawnPiece(w,h)); p.y = -20; }
    c.save(); c.translate(p.x,p.y); c.rotate(p.rot); c.fillStyle = p.color; c.fillRect(-p.size/2,-p.size/2,p.size,p.size*0.6); c.restore();
  }
}

/* ======== Şampiyon Ekran Görüntüsü ======== */
function revealChampionActions(){
  const area = byId('champion-actions');
  area.style.display = 'flex';
  const btn = byId('btn-shot');
  btn.replaceWith(btn.cloneNode(true));
  byId('btn-shot').addEventListener('click', () => captureStandingsScreenshot());
}

function formatNowTR(){
  const d = new Date();
  const pad = (n)=> String(n).padStart(2,'0');
  const yyyy = d.getFullYear(); const mm = pad(d.getMonth()+1); const dd = pad(d.getDate());
  const hh = pad(d.getHours()); const mi = pad(d.getMinutes()); const ss = pad(d.getSeconds());
  const pretty = `${dd}.${mm}.${yyyy} ${hh}:${mi}`;
  const safe = `${yyyy}-${mm}-${dd}_${hh}-${mi}-${ss}`;
  return {pretty, safe};
}
function slugify(s){ return (s||'sampiyon').normalize('NFKD').replace(/[\u0300-\u036f]/g,'').replace(/[^a-zA-Z0-9\-_. ]/g,'').trim().replace(/\s+/g,'_'); }

async function captureStandingsScreenshot(){
  const standingsSection = byId('standings-section');
  const team = championTeamCached || 'Takım';
  const {pretty, safe} = formatNowTR();

  const banner = document.createElement('div');
  banner.className = 'banner-shot';
  banner.id = 'shot-banner-temp';
  banner.innerHTML = `<span>🏆 ŞAMPİYON <strong>${team}</strong> — <span>${pretty}</span></span>`;
  standingsSection.insertBefore(banner, standingsSection.querySelector('.table-responsive'));

  try{
    const canvas = await html2canvas(standingsSection, {backgroundColor: null, scale: 2, useCORS: true});
    canvas.toBlob((blob)=>{
      const a = document.createElement('a');
      const url = URL.createObjectURL(blob);
      const fname = `sampiyon_${slugify(team)}_${safe}.png`;
      a.href = url; a.download = fname; document.body.appendChild(a); a.click();
      setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 0);
      showNotification(`Görüntü indirildi: ${fname}`, 'success');
    }, 'image/png');
  }catch(err){
    console.error(err);
    showNotification('Ekran görüntüsü alınırken bir sorun oluştu.', 'error');
  }finally{
    const temp = byId('shot-banner-temp'); if(temp) temp.remove();
  }
}

/* ======== INIT ======== */
document.addEventListener('DOMContentLoaded',()=>{
  byId('add-player-btn').addEventListener('click', addPlayer);
  byId('generate-btn').addEventListener('click', generateFixture);
  // YENİ: ID yerine class ile tüm sıfırlama butonlarına event ekleniyor
  document.querySelectorAll('.reset-tournament-btn').forEach(button => {
    button.addEventListener('click', resetTournament);
  });
  byId('prev-week-btn').addEventListener('click', handlePrevWeekClick);
  byId('next-week-btn').addEventListener('click', handleNextWeekClick);
  document.querySelectorAll('.close').forEach(el=>el.addEventListener('click',()=>closeModal(el.dataset.close)));
  document.addEventListener('keydown',(e)=>{
    if(e.key==='Escape') closeModal('player-modal');
    if(e.key==='Enter' && byId('players-section').style.display!=='none') addPlayer();
    if(e.key==='ArrowLeft' && byId('fixture-section').style.display!=='none') changeDisplayWeek(-1);
    if(e.key==='ArrowRight' && byId('fixture-section').style.display!=='none') changeDisplayWeek(1);
  });
  document.addEventListener('click',(e)=>{
    const t = e.target.closest('.tournament-type');
    if(t){ document.querySelectorAll('.tournament-type').forEach(x=>x.classList.remove('active')); t.classList.add('active'); tournamentType = t.dataset.type; }
  });

  loadState();
});
</script>
</body>
</html>